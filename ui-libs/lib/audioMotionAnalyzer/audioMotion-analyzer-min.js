/**!
 * audioMotion-analyzer
 * High-resolution real-time graphic audio spectrum analyzer JS module
 *
 * @version 4.1.0
 * @author  Henrique Avila Vianna <hvianna@gmail.com> <https://henriquevianna.com>
 * @license AGPL-3.0-or-later
 */const ft="4.1.0",ye=2*Math.PI,De=Math.PI/2,ut=ye/3600,$e=8.17579892,xe="dual-combined",fe="single",Y="dual-vertical",je="bar-index",Qe="bar-level",ve="gradient",gt="#111",Ke="",Je="A",Ze="B",et="C",tt="D",it="468",Te="sans-serif",mt="#0f0",pt="#7f7f7f22",Rt="create",st="fschange",Lt="lores",wt="resize",qe="user",At="#000c",at="#fff",bt="#4f4",nt="#888",yt="#555",ze="bark",_e="linear",me="log",ke="mel",rt=["#a35","#c66","#e94","#ed0","#9d5","#4d8","#2cb","#0bc","#09c","#36b"],lt=[["classic",{colorStops:["red",{color:"yellow",level:.85,pos:.6},{color:"lime",level:.475}]}],["prism",{colorStops:rt}],["rainbow",{dir:"h",colorStops:["#817",...rt,"#639"]}],["orangered",{bgColor:"#3e2f29",colorStops:["OrangeRed"]}],["steelblue",{bgColor:"#222c35",colorStops:["SteelBlue"]}]],St=["ERR_AUDIO_CONTEXT_FAIL","Could not create audio context. Web Audio API not supported?"],Et=["ERR_INVALID_AUDIO_CONTEXT","Provided audio context is not valid"],Ct=["ERR_UNKNOWN_GRADIENT","Unknown gradient"],He=["ERR_FREQUENCY_TOO_LOW","Frequency values must be >= 1"],Bt=["ERR_INVALID_MODE","Invalid mode"],xt=["ERR_REFLEX_OUT_OF_RANGE","Reflex ratio must be >= 0 and < 1"],vt=["ERR_INVALID_AUDIO_SOURCE","Audio source must be an instance of HTMLMediaElement or AudioNode"],Tt=["ERR_GRADIENT_INVALID_NAME","Gradient name must be a non-empty string"],Ot=["ERR_GRADIENT_NOT_AN_OBJECT","Gradient options must be an object"],It=["ERR_GRADIENT_MISSING_COLOR","Gradient colorStops must be a non-empty array"];class le extends Error{constructor(e,i){const[s,h]=e;super(h+(i!==void 0?`: ${i}`:""));this.name="AudioMotionError",this.code=s}}const ot=(Se,e)=>console.warn(`${Se} is deprecated. Use ${e} instead.`),Oe=(Se,e,i="toLowerCase")=>e[Math.max(0,e.indexOf((""+Se)[i]()))];class Mt{constructor(e,i={}){this._ready=!1,this._aux={},this._flg={},this._gradients={},this._selectedGrads=[],this._canvasGradients=[];for(const[t,_]of lt)this.registerGradient(t,_);this._container=e||document.body,this._defaultWidth=this._container.clientWidth||640,this._defaultHeight=this._container.clientHeight||270;let s;if(!(i.source&&(s=i.source.context))){if(!(s=i.audioCtx))try{s=new(window.AudioContext||window.webkitAudioContext)}catch(t){throw new le(St)}}if(!s.createGain)throw new le(Et);const h=this._analyzer=[s.createAnalyser(),s.createAnalyser()],c=this._splitter=s.createChannelSplitter(2),o=this._merger=s.createChannelMerger(2);this._input=s.createGain(),this._output=s.createGain(),this._sources=[],i.source&&this.connectInput(i.source);for(const t of[0,1])c.connect(h[t],t);o.connect(this._output),this._outNodes=[],i.connectSpeakers!==!1&&this.connectOutput(),this._energy={val:0,peak:0,hold:0};const a=document.createElement("canvas");a.style="max-width: 100%;",this._canvasCtx=a.getContext("2d");for(const t of["_scaleX","_scaleR"])this[t]=document.createElement("canvas").getContext("2d");this._fsEl=i.fsElement||a;const l=()=>{this._fsTimeout||(this._fsTimeout=window.setTimeout(()=>{this._fsChanging||(this._setCanvas(wt),this._fsTimeout=0)},60))};if(window.ResizeObserver){const t=new ResizeObserver(l);t.observe(this._container)}window.addEventListener("resize",l),a.addEventListener("fullscreenchange",()=>{this._fsChanging=!0,this._fsTimeout&&window.clearTimeout(this._fsTimeout),this._setCanvas(st),this._fsTimeout=window.setTimeout(()=>{this._fsChanging=!1,this._fsTimeout=0},60)});const A=()=>{s.state=="suspended"&&s.resume(),window.removeEventListener("click",A)};window.addEventListener("click",A),this._setProps(i,!0),this.useCanvas&&this._container.appendChild(a),this._ready=!0,this._setCanvas(Rt)}get alphaBars(){return this._alphaBars}set alphaBars(e){this._alphaBars=!!e,this._calcBars()}get ansiBands(){return this._ansiBands}set ansiBands(e){this._ansiBands=!!e,this._calcBars()}get barSpace(){return this._barSpace}set barSpace(e){this._barSpace=+e||0,this._calcBars()}get channelLayout(){return this._chLayout}set channelLayout(e){this._chLayout=Oe(e,[fe,Y,xe]),this._input.disconnect(),this._input.connect(this._chLayout!=fe?this._splitter:this._analyzer[0]),this._analyzer[0].disconnect(),this._outNodes.length&&this._analyzer[0].connect(this._chLayout!=fe?this._merger:this._output),this._calcBars(),this._makeGrad()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=Oe(e,[ve,je,Qe])}get fftSize(){return this._analyzer[0].fftSize}set fftSize(e){for(const s of[0,1])this._analyzer[s].fftSize=e;const i=this._analyzer[0].frequencyBinCount;this._fftData=[new Float32Array(i),new Float32Array(i)],this._calcBars()}get frequencyScale(){return this._frequencyScale}set frequencyScale(e){this._frequencyScale=Oe(e,[me,ze,ke,_e]),this._calcBars()}get gradient(){return this._selectedGrads[0]}set gradient(e){this._setGradient(e)}get gradientLeft(){return this._selectedGrads[0]}set gradientLeft(e){this._setGradient(e,0)}get gradientRight(){return this._selectedGrads[1]}set gradientRight(e){this._setGradient(e,1)}get height(){return this._height}set height(e){this._height=e,this._setCanvas(qe)}get ledBars(){return this._showLeds}set ledBars(e){this._showLeds=!!e,this._calcBars()}get linearAmplitude(){return this._linearAmplitude}set linearAmplitude(e){this._linearAmplitude=!!e}get linearBoost(){return this._linearBoost}set linearBoost(e){this._linearBoost=e>=1?+e:1}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=+e||0}get loRes(){return this._loRes}set loRes(e){this._loRes=!!e,this._setCanvas(Lt)}get lumiBars(){return this._lumiBars}set lumiBars(e){this._lumiBars=!!e,this._calcBars(),this._makeGrad()}get maxDecibels(){return this._analyzer[0].maxDecibels}set maxDecibels(e){for(const i of[0,1])this._analyzer[i].maxDecibels=e}get maxFreq(){return this._maxFreq}set maxFreq(e){if(e<1)throw new le(He);this._maxFreq=Math.min(e,this.audioCtx.sampleRate/2),this._calcBars()}get minDecibels(){return this._analyzer[0].minDecibels}set minDecibels(e){for(const i of[0,1])this._analyzer[i].minDecibels=e}get minFreq(){return this._minFreq}set minFreq(e){if(e<1)throw new le(He);this._minFreq=+e,this._calcBars()}get mirror(){return this._mirror}set mirror(e){this._mirror=Math.sign(e)|0,this._calcBars(),this._makeGrad()}get mode(){return this._mode}set mode(e){const i=e|0;if(i>=0&&i<=10&&i!=9)this._mode=i,this._calcBars(),this._makeGrad();else throw new le(Bt,e)}get noteLabels(){return this._noteLabels}set noteLabels(e){this._noteLabels=!!e,this._createScales()}get outlineBars(){return this._outlineBars}set outlineBars(e){this._outlineBars=!!e,this._calcBars()}get radial(){return this._radial}set radial(e){this._radial=!!e,this._calcBars(),this._makeGrad()}get reflexRatio(){return this._reflexRatio}set reflexRatio(e){if(e=+e||0,e<0||e>=1)throw new le(xt);this._reflexRatio=e,this._calcBars(),this._makeGrad()}get roundBars(){return this._roundBars}set roundBars(e){this._roundBars=!!e,this._calcBars()}get smoothing(){return this._analyzer[0].smoothingTimeConstant}set smoothing(e){for(const i of[0,1])this._analyzer[i].smoothingTimeConstant=e}get spinSpeed(){return this._spinSpeed}set spinSpeed(e){e=+e||0,(this._spinSpeed===void 0||e==0)&&(this._spinAngle=-De),this._spinSpeed=e}get splitGradient(){return this._splitGradient}set splitGradient(e){this._splitGradient=!!e,this._makeGrad()}get stereo(){return ot("stereo","channelLayout"),this._chLayout!=fe}set stereo(e){ot("stereo","channelLayout"),this.channelLayout=e?Y:fe}get trueLeds(){return this._trueLeds}set trueLeds(e){this._trueLeds=!!e}get volume(){return this._output.gain.value}set volume(e){this._output.gain.value=e}get weightingFilter(){return this._weightingFilter}set weightingFilter(e){this._weightingFilter=Oe(e,[Ke,Je,Ze,et,tt,it],"toUpperCase")}get width(){return this._width}set width(e){this._width=e,this._setCanvas(qe)}get audioCtx(){return this._input.context}get canvas(){return this._canvasCtx.canvas}get canvasCtx(){return this._canvasCtx}get connectedSources(){return this._sources}get connectedTo(){return this._outNodes}get fps(){return this._fps}get fsHeight(){return this._fsHeight}get fsWidth(){return this._fsWidth}get isAlphaBars(){return this._flg.isAlpha}get isBandsMode(){return this._flg.isBands}get isFullscreen(){return(document.fullscreenElement||document.webkitFullscreenElement)===this._fsEl}get isLedBars(){return this._flg.isLeds}get isLumiBars(){return this._flg.isLumi}get isOctaveBands(){return this._flg.isOctaves}get isOn(){return this._runId!==void 0}get isOutlineBars(){return this._flg.isOutline}get pixelRatio(){return this._pixelRatio}get isRoundBars(){return this._flg.isRound}static get version(){return ft}connectInput(e){const i=e instanceof HTMLMediaElement;if(!(i||e.connect))throw new le(vt);const s=i?this.audioCtx.createMediaElementSource(e):e;return this._sources.includes(s)||(s.connect(this._input),this._sources.push(s)),s}connectOutput(e=this.audioCtx.destination){if(this._outNodes.includes(e))return;if(this._output.connect(e),this._outNodes.push(e),this._outNodes.length==1)for(const i of[0,1])this._analyzer[i].connect(this._chLayout==fe&&!i?this._output:this._merger,0,i)}disconnectInput(e){e?Array.isArray(e)||(e=[e]):e=Array.from(this._sources);for(const i of e){const s=this._sources.indexOf(i);s>=0&&(i.disconnect(this._input),this._sources.splice(s,1))}}disconnectOutput(e){if(e&&!this._outNodes.includes(e))return;if(this._output.disconnect(e),this._outNodes=e?this._outNodes.filter(i=>i!==e):[],this._outNodes.length==0)for(const i of[0,1])this._analyzer[i].disconnect()}getBars(){return Array.from(this._bars,({posX:e,freq:i,freqLo:s,freqHi:h,hold:c,peak:o,value:a})=>({posX:e,freq:i,freqLo:s,freqHi:h,hold:c,peak:o,value:a}))}getEnergy(e,i){if(e===void 0)return this._energy.val;if(e!=+e){if(e=="peak")return this._energy.peak;const a={bass:[20,250],lowMid:[250,500],mid:[500,2e3],highMid:[2e3,4e3],treble:[4e3,16e3]};if(!a[e])return null;[e,i]=a[e]}const s=this._freqToBin(e),h=i?this._freqToBin(i):s,c=this._chLayout==fe?1:2;let o=0;for(let a=0;a<c;a++)for(let l=s;l<=h;l++)o+=this._normalizedB(this._fftData[a][l]);return o/(h-s+1)/c}registerGradient(e,i){if(typeof e!="string"||e.trim().length==0)throw new le(Tt);if(typeof i!="object")throw new le(Ot);const{colorStops:s}=i;if(!Array.isArray(s)||!s.length)throw new le(It);const h=s.length,c=o=>+o!=o||o<0||o>1;s.forEach((o,a)=>{const l=a/Math.max(1,h-1);typeof o!="object"?s[a]={pos:l,color:o}:c(o.pos)&&(o.pos=l),c(o.level)&&(s[a].level=1-a/h)}),s.sort((o,a)=>o.level<a.level?1:o.level>a.level?-1:0),s[0].level=1,this._gradients[e]={bgColor:i.bgColor||gt,dir:i.dir,colorStops:s},this._selectedGrads.includes(e)&&this._makeGrad()}setCanvasSize(e,i){this._width=e,this._height=i,this._setCanvas(qe)}setFreqRange(e,i){if(e<1||i<1)throw new le(He);this._minFreq=Math.min(e,i),this.maxFreq=Math.max(e,i)}setLedParams(e){let i,s,h;e&&(i=e.maxLeds|0,s=+e.spaceV,h=+e.spaceH),this._ledParams=i>0&&s>0&&h>=0?[i,s,h]:void 0,this._calcBars()}setOptions(e){this._setProps(e)}setSensitivity(e,i){for(const s of[0,1])this._analyzer[s].minDecibels=Math.min(e,i),this._analyzer[s].maxDecibels=Math.max(e,i)}toggleAnalyzer(e){const i=this.isOn;return e===void 0&&(e=!i),i&&!e?(cancelAnimationFrame(this._runId),this._runId=void 0):!i&&e&&(this._frame=this._fps=0,this._time=performance.now(),this._runId=requestAnimationFrame(s=>this._draw(s))),this.isOn}toggleFullscreen(){if(this.isFullscreen)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{const e=this._fsEl;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()}}_binToFreq(e){return e*this.audioCtx.sampleRate/this.fftSize||1}_calcBars(){const e=this._bars=[];if(!this._ready)return;const i=this._barSpace,s=this.canvas,h=s.width>>1,c=this._chLayout,o=this._ansiBands,a=this._radial,l=c==Y&&!a,A=this._maxFreq,t=this._minFreq,_=this._mode,m=_%10!=0,X=m&&this._frequencyScale==me,D=this._showLeds&&m&&!a,O=this._lumiBars&&m&&!a,N=this._alphaBars&&!O&&_!=10,ne=this._outlineBars&&m&&!O&&!D,S=this._roundBars&&m&&!O&&!D,j=c!=Y||this._reflexRatio>0&&!O,P=s.height-(l&&!D?.5:0)>>l,K=P*(O||a?1:1-this._reflexRatio)|0,E=s.width-h*(this._mirror!=0),M=l?s.height-P*2:0,C=h*(this._mirror==-1&&!a),$=Math.min(s.width,s.height)*(c==Y?.375:.125)|0,Z=g=>e.push({...g,peak:[0,0],hold:[0],value:[0]}),q=g=>{const p=this._freqToBin(g,"floor"),f=this._binToFreq(p),L=this._binToFreq(p+1),F=Math.log2(g/f)/Math.log2(L/f);return[p,F]};let B,R,u;if(X){const g=(b,v,ee)=>+b.toPrecision(ee?Math.max(v,1+Math.log10(b)|0):v),p=b=>{const v=[1,1.12,1.25,1.4,1.6,1.8,2,2.24,2.5,2.8,3.15,3.55,4,4.5,5,5.6,6.3,7.1,8,9,10],ee=Math.log10(b)|0,pe=b/10**ee;let oe=1;for(;oe<v.length&&pe>v[oe];)oe++;return pe-v[oe-1]<v[oe]-pe&&oe--,(v[oe]*10**(ee+5)|0)/1e5},f=[0,24,12,8,6,4,3,2,1][this._mode],L=o?10**(3/(f*10)):2**(1/f),F=L**.5;let H=o?7.94328235/(f%2?1:F):$e;do{let b=H;const v=g(b/F,4,!0),ee=g(b*F,4,!0),[pe,oe]=q(v),[Ie,Me]=q(ee);o?b=f<4?p(b):g(b,b.toString()[0]<5?3:2):b=g(b,4,!0),b>=t&&Z({posX:0,freq:b,freqLo:v,freqHi:ee,binLo:pe,binHi:Ie,ratioLo:oe,ratioHi:Me}),H*=L}while(H<=A);B=E/e.length,e.forEach((b,v)=>b.posX=C+v*B);const I=e[0],Q=e[e.length-1];R=this._freqScaling(I.freqLo),u=E/(this._freqScaling(Q.freqHi)-R),I.freqLo<t&&(I.freqLo=t,[I.binLo,I.ratioLo]=q(t)),Q.freqHi>A&&(Q.freqHi=A,[Q.binHi,Q.ratioHi]=q(A))}else if(m){const g=[0,24,12,8,6,4,3,2,1][this._mode]*10,p=f=>{switch(this._frequencyScale){case ze:return 1960/(26.81/(f+.53)-1);case ke:return 700*(2**f-1);case _e:return f}};B=E/g,R=this._freqScaling(t),u=E/(this._freqScaling(A)-R);for(let f=0,L=0;f<g;f++,L+=B){const F=p(R+L/u),H=p(R+(L+B/2)/u),I=p(R+(L+B)/u),[Q,b]=q(F),[v,ee]=q(I);Z({posX:C+L,freq:H,freqLo:F,freqHi:I,binLo:Q,binHi:v,ratioLo:b,ratioHi:ee})}}else{B=1,R=this._freqScaling(t),u=E/(this._freqScaling(A)-R);const g=this._freqToBin(t,"floor"),p=this._freqToBin(A);let f=-999;for(let L=g;L<=p;L++){const F=this._binToFreq(L),H=C+Math.round(u*(this._freqScaling(F)-R));if(H>f)Z({posX:H,freq:F,freqLo:F,freqHi:F,binLo:L,binHi:L,ratioLo:0,ratioHi:0}),f=H;else if(e.length){const I=e[e.length-1];I.binHi=L,I.freqHi=F,I.freq=(I.freqLo*F)**.5}}}let x=0,d=0;if(D){const g=this._pixelRatio/(window.devicePixelRatio>1&&window.screen.height<=540?2:1),p=[[],[128,3,.45],[128,4,.225],[96,6,.225],[80,6,.225],[80,6,.125],[64,6,.125],[48,8,.125],[24,16,.125]],f=this._ledParams,[L,F,H]=f||p[_];let I,Q=K;if(f){const b=2*g;let v;I=L+1;do I--,v=Q/I/(1+F),d=v*F;while((v<b||d<b)&&I>1)}else{const b=540/F;d=Math.min(F*g,Math.max(2,Q/b+.1|0))}j&&(Q+=d),f||(I=Math.min(L,Q/(d*2)|0)),x=H>=1?H:B*H,this._leds=[I,x,d,Q/I-d]}const W=Math.min(B-1,i*(i>0&&i<1?B:1));m&&(B-=Math.max(D?x:0,W)),e.forEach((g,p)=>{let f=g.posX,L=B;m&&(i==0&&!D?(f|=0,L|=0,p>0&&f>e[p-1].posX+e[p-1].width&&(f--,L++)):f+=Math.max(D?x:0,W)/2,g.posX=f),g.barCenter=f+(B==1?0:L/2),g.width=L});const ce=[];for(const g of[0,1]){const p=c==Y?(P+M)*g:0,f=p+P,L=p+K-(!D||j?0:d);ce.push({channelTop:p,channelBottom:f,analyzerBottom:L})}this._aux={analyzerHeight:K,analyzerWidth:E,channelCoords:ce,channelHeight:P,channelGap:M,initialX:C,radius:$,scaleMin:R,unitWidth:u},this._flg={isAlpha:N,isBands:m,isLeds:D,isLumi:O,isOctaves:X,isOutline:ne,isRound:S,noLedGap:j},this._createScales()}_createScales(){if(!this._ready)return;const{analyzerWidth:e,initialX:i,radius:s,scaleMin:h,unitWidth:c}=this._aux,o=this._canvasCtx.canvas,a=this._scaleX,l=this._scaleR,A=a.canvas,t=l.canvas,_=[],m=this._frequencyScale,X=this._noteLabels,D=this._radial,O=this._chLayout==Y,N=this._mirror,ne=["C",,"D",,"E","F",,"G",,"A",,"B"],S=Math.min(o.width,o.height)/34|0,j=A.height>>1,P=S>>1,K=j*(X?.7:1.5),E=P*(X?1:2),M=2**(1/12);if(!X&&(this._ansiBands||m!=me))_.push(16,31.5,63,125,250,500,1e3,2e3,4e3),m==_e?_.push(6e3,8e3,1e4,12e3,14e3,16e3,18e3,2e4,22e3):_.push(8e3,16e3);else{let R=$e;for(let u=-1;u<11;u++)for(let x=0;x<12;x++){if(R>=this._minFreq&&R<=this._maxFreq){const d=ne[x],W=d=="C";(d&&X&&!N||W)&&_.push(X?[R,d+(W?u:"")]:R)}R*=M}}t.width=t.height=(s<<1)+O*S;const C=t.width>>1,$=C-S*.7,Z=(R,u)=>{const x=ye*(R/o.width),d=x-De,W=$*Math.cos(d),ce=$*Math.sin(d);l.save(),l.translate(C+W,C+ce),l.rotate(x),l.fillText(u,0,0),l.restore()};A.width|=0,a.fillStyle=l.strokeStyle=At,a.fillRect(0,0,A.width,A.height),l.arc(C,C,C-S/2,0,ye),l.lineWidth=S,l.stroke(),a.fillStyle=l.fillStyle=at,a.font=`${j}px ${Te}`,l.font=`${P}px ${Te}`,a.textAlign=l.textAlign="center";let q=-K/4,B=-E;for(const R of _){const[u,x]=Array.isArray(R)?R:[R,R<1e3?R|0:`${(R/100|0)/10}k`],d=c*(this._freqScaling(u)-h),W=A.height*.75,ce=x[0]=="C",g=j*(X&&!N?ce?1.2:.6:3);if(a.fillStyle=l.fillStyle=ce&&!N?bt:at,X){let p=["C"];if((m==me||u>2e3||m!=_e&&u>250||(!D||O)&&(m!=_e&&u>125||u>1e3))&&p.push("G"),(m==me||u>4e3||m!=_e&&u>500||(!D||O)&&(m!=_e&&u>250||u>2e3))&&p.push("E"),(m==_e&&u>4e3||(!D||O)&&(m==me||u>2e3||m!=_e&&u>500))&&p.push("D","F","A","B"),!p.includes(x[0]))continue}d>=q+K/2&&d<=e&&(a.fillText(x,i+d,W,g),N&&(d>K||N==1)&&a.fillText(x,(i||o.width)-d,W,g),q=d+Math.min(g,a.measureText(x).width)/2),d>=B+E&&d<e-E&&(Z(d,x),N&&(d>E||N==1)&&Z(-d,x),B=d)}}_draw(e){const{isAlpha:i,isBands:s,isLeds:h,isLumi:c,isOctaves:o,isOutline:a,isRound:l,noLedGap:A}=this._flg,t=this._canvasCtx,_=t.canvas,m=this._scaleX.canvas,X=this._scaleR.canvas,D=this._canvasGradients,O=_.width>>1,N=_.height>>1,ne=this._colorMode,S=this._energy,j=this.fillAlpha,P=this._mode,K=this._linearAmplitude,E=this.overlay,M=this._radial,C=h&&this._trueLeds&&ne==ve,$=this._chLayout,Z=this._lineWidth,q=this._mirror,{analyzerHeight:B,channelCoords:R,channelHeight:u,channelGap:x,initialX:d,radius:W}=this._aux,ce=M?_.width:this._aux.analyzerWidth,g=d+ce,p=this.showBgColor,f=M?Math.min(O,N)-W:B,L=this.maxDecibels,F=this.minDecibels,H=this.useCanvas,I=this._weightingFilter,[Q,b,v,ee]=this._leds||[];S.val>0&&(this._spinAngle+=this._spinSpeed*ut);const pe=n=>{if(this._reflexRatio>0&&!c){let r,z;this.reflexFit||$==Y?(r=$==Y&&n==0?u+x:0,z=u-B):(r=_.height-B*2,z=B),t.save(),t.globalAlpha=this.reflexAlpha,this.reflexBright!=1&&(t.filter=`brightness(${this.reflexBright})`),t.setTransform(1,0,0,-1,0,_.height),t.drawImage(_,0,R[n].channelTop,_.width,B,0,r,_.width,z),t.restore()}},oe=()=>{this.showScaleX&&(M?(t.save(),t.translate(O,N),this._spinSpeed&&t.rotate(this._spinAngle+De),t.drawImage(X,-X.width>>1,-X.width>>1),t.restore()):t.drawImage(m,0,_.height-m.height))},Ie=n=>{const r=m.height,z=r>>1,w=K?100:L,te=K?0:F,U=K?20:5,J=B/(w-te);t.save(),t.fillStyle=nt,t.font=`${z}px ${Te}`,t.textAlign="right",t.lineWidth=1;for(let V=w;V>te;V-=U){const he=n+(w-V)*J,ue=V%2==0|0;if(ue){const ge=he+z*(he==n?.8:.35);q!=-1&&t.fillText(V,r*.85,ge),q!=1&&t.fillText(V,_.width-r*.1,ge),t.strokeStyle=nt,t.setLineDash([2,4]),t.lineDashOffset=0}else t.strokeStyle=yt,t.setLineDash([2,8]),t.lineDashOffset=1;t.beginPath(),t.moveTo(d+r*ue*(q!=-1),~~he+.5),t.lineTo(g-r*ue*(q!=1),~~he+.5),t.stroke()}t.restore()},Me=n=>{const r=n**2,z=424.36,w=11599.29,te=25122.25,U=544496.41,J=148693636,V=he=>20*Math.log10(he);switch(I){case Je:const he=J*r**2/((r+z)*Math.sqrt((r+w)*(r+U))*(r+J));return 2+V(he);case Ze:const ue=J*r*n/((r+z)*Math.sqrt(r+te)*(r+J));return .17+V(ue);case et:const ge=J*r/((r+z)*(r+J));return .06+V(ge);case tt:const ie=((103791848e-2-r)**2+108076816e-2*r)/((9837328-r)**2+11723776*r),Ce=n/68966888496476e-18*Math.sqrt(ie/((r+79919.29)*(r+1345600)));return V(Ce);case it:const T=-4737338981378384e-39*n**6+2043828333606125e-30*n**4-1363894795463638e-22*r+1,k=1306612257412824e-34*n**5-2118150887518656e-26*n**3+.0005559488023498642*n,y=.0001246332637532143*n/Math.hypot(T,k);return 18.2+V(y)}return 0},Ne=(n,r,z)=>{t.beginPath(),t.moveTo(n,r),t.lineTo(n,z),t.stroke()},Fe=n=>{if(n&&Z){const r=t.globalAlpha;t.globalAlpha=1,t.stroke(),t.globalAlpha=r}},Ge=(n,r)=>r*ye*(n/_.width)+this._spinAngle,Re=(n,r,z)=>{const w=W+r,te=Ge(n,z);return[O+w*Math.cos(te),N+w*Math.sin(te)]},Xe=(n,r,z,w,te)=>{t.beginPath();for(const U of q?[1,-1]:[1]){const[J,V]=l?[Ge(n,U),Ge(n+z,U)]:[];t.moveTo(...Re(n,r,U)),t.lineTo(...Re(n,r+w,U)),l?t.arc(O,N,W+r+w,J,V):t.lineTo(...Re(n+z,r+w,U)),t.lineTo(...Re(n+z,r,U)),l&&!te&&t.arc(O,N,W+r,V,J,!0)}Fe(te),t.fill()},Le=n=>Math.max(0,(n*Q|0)*(ee+v)-v),ht=n=>{S.val=n,n>=S.peak?(S.peak=n,S.hold=30):S.hold>0?S.hold--:S.peak>0&&(S.peak*=(30+S.hold--)/30)},ct=()=>{this._frame++;const n=e-this._time;if(n>=1e3&&(this._fps=this._frame/(n/1e3),this._frame=0,this._time=e),this.showFPS){const r=m.height;t.font=`bold ${r}px ${Te}`,t.fillStyle=mt,t.textAlign="right",t.fillText(Math.round(this._fps),_.width-r,r*2)}};let Pe=0;const Ee=this._bars,We=Ee.length,Ue=$==fe?1:2;for(let n=0;n<Ue;n++){const{channelTop:r,channelBottom:z,analyzerBottom:w}=R[n],te=this._gradients[this._selectedGrads[n]],U=te.colorStops,J=U.length,V=!p||h&&!E?"#000":te.bgColor,he=n==0||!M&&$!=xe,ue=(T,k)=>{const y=ie[T]+(T<ie.length-1?(ie[T+1]-ie[T])*k:0);return isNaN(y)?-Infinity:y},ge=(T=0,k=0)=>{let y;if(ne==ve&&!C||P==10)y=D[n];else{const Ae=ne==je?k%J:U.findLastIndex(de=>h?Le(T)<=Le(de.level):T<=de.level);y=U[Ae].color}t.fillStyle=t.strokeStyle=y};if(H&&(E&&he&&t.clearRect(0,r-x,_.width,u+x),(!E||p)&&(E&&(t.globalAlpha=this.bgAlpha),t.fillStyle=V,he&&t.fillRect(d,r-x,ce,(E&&this.reflexAlpha==1?B:u)+x),t.globalAlpha=1),this.showScaleY&&!c&&!M&&(n==0||$!=xe)&&Ie(r),h?(t.setLineDash([ee,v]),t.lineWidth=Ee[0].width):t.lineWidth=a?Math.min(Z,Ee[0].width/2):Z,t.save(),!M)){const T=new Path2D;T.rect(0,r,_.width,B),t.clip(T)}let ie=this._fftData[n];this._analyzer[n].getFloatFrequencyData(ie),I&&(ie=ie.map((T,k)=>T+Me(this._binToFreq(k)))),t.beginPath();let Ce=[];for(let T=0;T<We;T++){const k=Ee[T],{posX:y,barCenter:Ae,width:de,freq:Nt,binLo:Be,binHi:Ve,ratioLo:dt,ratioHi:_t}=k;let se=Math.max(ue(Be,dt),ue(Ve,_t));for(let G=Be+1;G<Ve;G++)ie[G]>se&&(se=ie[G]);if(se=this._normalizedB(se),k.value[n]=se,Pe+=se,k.peak[n]>0&&(k.hold[n]--,k.hold[n]<0&&(k.peak[n]+=k.hold[n]/f)),se>=k.peak[n]&&(k.peak[n]=se,k.hold[n]=30),!H)continue;c||i?t.globalAlpha=se:a&&(t.globalAlpha=j),ge(se,T);let ae=c?f:h?Le(se):se*f|0;if(M&&n==1&&$==Y&&(ae*=-1),P==10){const G=T?0:(this._normalizedB(ie[Ee[1].binLo])*f*(n&&M&&$==Y?-1:1)+ae)/2;if(M){if(T==0&&t.lineTo(...Re(0,y<0?G:ae,1)),y>=0){const re=[y,ae];t.lineTo(...Re(...re,1)),Ce.push(re)}}else{if(T==0)if(q!=-1){const re=Be?this._normalizedB(ie[Be-1])*f:ae;t.moveTo(d-Z,w-re)}else t.moveTo(d,w-(y<d?G:ae));(q!=-1||y>=d)&&t.lineTo(y,w-ae)}}else if(h){if(p&&!E&&(n==0||$!=xe)){const G=t.globalAlpha;t.strokeStyle=pt,t.globalAlpha=1,Ne(Ae,r,w),t.strokeStyle=t.fillStyle,t.globalAlpha=G}if(C){const G=c?0:U.findLastIndex(we=>Le(se)<=Le(we.level));let re=w;for(let we=J-1;we>=G;we--){t.strokeStyle=U[we].color;let Ye=w-(we==G?ae:Le(U[we].level));Ne(Ae,re,Ye),re=Ye-v}}else Ne(Ae,w,w-ae)}else if(y>=d)if(M)Xe(y,0,de,ae,a);else if(l){const G=de/2,re=w+G;t.beginPath(),t.moveTo(y,re),t.lineTo(y,re-ae),t.arc(Ae,re-ae,G,Math.PI,ye),t.lineTo(y+de,re),Fe(a),t.fill()}else{const G=a?t.lineWidth:0;t.beginPath(),t.rect(y,w+G,de,-ae-G),Fe(a),t.fill()}const be=k.peak[n];if(be>0&&this.showPeaks&&!c&&y>=d&&y<g)if(a&&Z>0?t.globalAlpha=1:i&&(t.globalAlpha=be),(ne==Qe||C)&&ge(be),h){const G=Le(be);G>=v&&t.fillRect(y,w-G,de,ee)}else M?P!=10&&Xe(y,be*f*(n&&$==Y?-1:1),de,-2):t.fillRect(y,w-be*f,de,2)}if(!H)continue;if(t.restore(),t.globalAlpha=1,P==10){if(ge(),M){if(q){let T;for(;T=Ce.pop();)t.lineTo(...Re(...T,-1))}t.closePath()}Z>0&&t.stroke(),j>0&&(M?(t.moveTo(O+W,N),t.arc(O,N,W,0,ye,!0)):(t.lineTo(g,w),t.lineTo(d,w)),t.globalAlpha=j,t.fill(),t.globalAlpha=1)}pe(n)}ht(Pe/(We<<Ue-1)),H&&(q&&!M&&(t.setTransform(-1,0,0,1,_.width-d,0),t.drawImage(_,d,0,O,_.height,0,0,O,_.height),t.setTransform(1,0,0,1,0,0)),t.setLineDash([]),oe()),ct(),this.onCanvasDraw&&(t.save(),t.fillStyle=t.strokeStyle=D[0],this.onCanvasDraw(this,{timestamp:e,canvasGradients:D}),t.restore()),this._runId=requestAnimationFrame(n=>this._draw(n))}_freqScaling(e){switch(this._frequencyScale){case me:return Math.log2(e);case ze:return 26.81*e/(1960+e)-.53;case ke:return Math.log2(1+e/700);case _e:return e}}_freqToBin(e,i="round"){const s=this._analyzer[0].frequencyBinCount-1,h=Math[i](e*this.fftSize/this.audioCtx.sampleRate);return h<s?h:s}_makeGrad(){if(!this._ready)return;const e=this._canvasCtx,i=e.canvas,s=this._chLayout,{isLumi:h}=this._flg,c=this._radial,o=h?i.height:i.height*(1-this._reflexRatio*(s!=Y))|0,a=1-this._reflexRatio,{analyzerWidth:l,initialX:A,radius:t}=this._aux,_=i.width>>1,m=i.height>>1,X=Math.min(_,m);for(const D of[0,1]){const O=this._gradients[this._selectedGrads[D]],N=O.colorStops,ne=O.dir=="h";let S;if(c?S=e.createRadialGradient(_,m,X,_,m,t-(X-t)*(s==Y)):S=e.createLinearGradient(...ne?[A,0,A+l,0]:[0,0,0,o]),N){const j=s==Y&&!this._splitGradient&&(!ne||c);for(let P=0;P<1+j;P++){const K=N.length-1;N.forEach((E,M)=>{let C=E.pos;if(j&&(C/=2),s==Y&&!h&&!c&&!ne&&(C*=a,!j&&C>.5*a&&(C+=.5*this._reflexRatio)),P==1)if(c||h){const $=K-M;E=N[$],C=1-E.pos/2}else M==0&&C>0&&S.addColorStop(.5,E.color),C+=.5;S.addColorStop(C,E.color),s==Y&&M==K&&C<.5&&S.addColorStop(.5,E.color)})}}this._canvasGradients[D]=S}}_normalizedB(e){const i=this._linearAmplitude,s=i?1/this._linearBoost:1,h=(l,A,t)=>l<=A?A:l>=t?t:l,c=l=>10**(l/20);let o=this.maxDecibels,a=this.minDecibels;return i&&(o=c(o),a=c(a),e=c(e)**s),h((e-a)/(o-a)**s,0,1)}_setCanvas(e){if(!this._ready)return;const i=this._canvasCtx,s=i.canvas,h=this._scaleX.canvas,c=window.devicePixelRatio/(this._loRes+1);let o=window.screen.width*c,a=window.screen.height*c;Math.abs(window.orientation)==90&&o<a&&([o,a]=[a,o]);const l=this.isFullscreen,A=l&&this._fsEl==s,t=A?o:(this._width||this._container.clientWidth||this._defaultWidth)*c|0,_=A?a:(this._height||this._container.clientHeight||this._defaultHeight)*c|0;if(this._pixelRatio=c,this._fsWidth=o,this._fsHeight=a,s.width==t&&s.height==_)return;s.width=t,s.height=_,this.overlay||(i.fillStyle="#000",i.fillRect(0,0,t,_)),i.lineJoin="bevel",h.width=t,h.height=Math.max(20*c,Math.min(t,_)/32|0),this._calcBars(),this._makeGrad(),this._fsStatus!==void 0&&this._fsStatus!==l&&(e=st),this._fsStatus=l,this.onCanvasResize&&this.onCanvasResize(e,this)}_setGradient(e,i){if(!this._gradients.hasOwnProperty(e))throw new le(Ct,e);[0,1].includes(i)||(this._selectedGrads[1]=e,i=0),this._selectedGrads[i]=e,this._makeGrad()}_setProps(e,i){const s={alphaBars:!1,ansiBands:!1,barSpace:.1,bgAlpha:.7,channelLayout:fe,colorMode:ve,fftSize:8192,fillAlpha:1,frequencyScale:me,gradient:lt[0][0],ledBars:!1,linearAmplitude:!1,linearBoost:1,lineWidth:0,loRes:!1,lumiBars:!1,maxDecibels:-25,maxFreq:22e3,minDecibels:-85,minFreq:20,mirror:0,mode:0,noteLabels:!1,outlineBars:!1,overlay:!1,radial:!1,reflexAlpha:.15,reflexBright:1,reflexFit:!0,reflexRatio:0,roundBars:!1,showBgColor:!0,showFPS:!1,showPeaks:!0,showScaleX:!0,showScaleY:!1,smoothing:.5,spinSpeed:0,splitGradient:!1,start:!0,trueLeds:!1,useCanvas:!0,volume:1,weightingFilter:Ke},h=["onCanvasDraw","onCanvasResize"],c=["gradientLeft","gradientRight","height","width","stereo"],o=Object.keys(s).filter(a=>a!="start").concat(h,c);(i||e===void 0)&&(e={...s,...e});for(const a of Object.keys(e))h.includes(a)&&typeof e[a]!="function"?this[a]=void 0:o.includes(a)&&(this[a]=e[a]);e.start!==void 0&&this.toggleAnalyzer(e.start)}}export default Mt;
 